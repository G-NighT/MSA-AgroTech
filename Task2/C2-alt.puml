@startuml C2-alt

!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

top to bottom direction

title C2 — Платформа мониторинга скота (Cloud-first: центральный инференс, тонкий Edge)

' Акторы
Person(op, "Оператор фермы", "Реакция на события, подтверждение инцидентов")
Person(vet, "Ветврач/Зоотехник", "Анализ состояния животных")
Person(dir, "Директор хозяйства", "Сводная аналитика и KPI")
Person(analyst, "Аналитик", "Работа с BI/отчётами")
Person(mobile, "Мобильное приложение", "Уведомления, быстрые действия")

' Внешние системы
System_Ext(cam, "IP-камеры", "RTSP/ONVIF")
System_Ext(sensors, "Датчики/актуаторы", "кормушки, поилки, фильтры воды")
System_Ext(bi, "BI/ВИ-система", "Витрины/отчёты")
System_Ext(erp, "ERP", "REST/ETL: справочники/склад")
System_Ext(notif, "Сервис уведомлений", "SMS/Email/WebPush")

' Ферма / Edge (тонкий агент)
Boundary(edge, "Ферма / Edge (тонкий агент)") {
  Container(edgeAgent, "Агент фермы (тонкий)", "Сервис", "Захват видео, буфер/очередь, шифрование, отправка в центр")
  Container(edgeFallback, "Fallback-эвристики", "Сервис", "Простейшие локальные правила при офлайне (без нейросетей)")
  ContainerDb(edgeDb, "Локальная БД Edge", "SQLite", "Буфер клипов/метаданных, очередь на отправку")
}

' Связи Edge
Rel(cam, edgeAgent, "Live-видео", "RTSP/WebRTC (LAN)")
Rel(edgeAgent, edgeDb, "Буфер при офлайне", "SQL")

' Центральная платформа (cloud-first)
Boundary(central, "Центральная платформа (cloud-first)") {
  Container(api, "API Gateway", "Сервис", "REST/gRPC для веб/мобилы и интеграций; WebSocket/SSE")
  Container(auth, "IAM/SSO", "Сервис", "OIDC/SAML; RBAC")

  Container(streamGw, "Stream Gateway", "Сервис", "Ингест Live-видео с ферм (WebRTC/RTMP), нарезка клипов")
  Container(infer, "Realtime Inference (GPU)", "Сервис", "Центральный инференс; запуск партнёрских моделей; gRPC")
  Container(orchestrator, "Core: Платформа мониторинга", "Сервис", "Обработка результатов инференса, кейс-логика, оповещения")
  Container(iot, "IoT Core (MQTT)", "Брокер", "Телеметрия/команды устройств, единая точка для всех ферм")

  Container(mediaSvc, "Media Service", "Сервис", "Загрузка и выдача pre-signed URL для клипов/кадров")
  Container(configSvc, "Config/Feature Service", "Сервис", "Пороги, ROI, фичфлаги, таргетинг по фермам/камерам")
  Container(reg, "Model Registry & Policy", "Сервис", "Реестр/версии моделей, политика выката; доставка в GPU-кластер")

  Container(eventBus, "Event Bus (pub/sub)", "Сервис", "Внутренняя шина событий: inference.results, incidents, alerts")
  ContainerDb(opDb, "Операционная БД", "PostgreSQL", "Инциденты, кейсы, справочники, outbox")
  ContainerDb(tsDb, "Хранилище телеметрии", "Timescale/ClickHouse", "Ряды/агрегаты")
  Container(object, "Объектное хранилище (S3)", "Хранилище", "Клипы/кадры/артефакты")
  Container(cache, "Redis (опц.)", "Кэш", "Сессии WS, rate-limit, краткоживущие данные")
}

' Пользователи и API
Rel(op, api, "Веб-портал", "HTTPS")
Rel(vet, api, "Веб-портал", "HTTPS")
Rel(mobile, api, "Мобильное приложение", "HTTPS")
Rel(api, auth, "Аутентификация/авторизация", "OIDC/OAuth2")
Rel(api, orchestrator, "Запросы UI/интеграций", "REST/gRPC")
Rel(api, orchestrator, "Онлайновые обновления ленты", "WS/SSE")

' Видеопотоки и инференс
Rel(edgeAgent, streamGw, "Поток видео/клипы", "WebRTC/RTMP")
Rel(streamGw, infer, "Кадры/клипы на инференс", "gRPC")
Rel(infer, eventBus, "Публикует результаты", "pub/sub")
Rel(eventBus, orchestrator, "Подписка на результаты", "pub/sub")

' Телеметрия/команды
Rel(sensors, iot, "Телеметрия/статусы", "MQTT")
Rel(orchestrator, iot, "Команды устройствам", "MQTT")

' Медиа и данные
Rel(edgeAgent, object, "Загрузка клипов/кадров по событию", "S3 API (pre-signed)")
Rel(mediaSvc, object, "Генерирует pre-signed URL; политика TTL", "S3 SDK")
Rel(api, mediaSvc, "Запрос ссылок из UI/мобилы", "REST")

Rel(orchestrator, opDb, "CRUD/запросы", "SQL")
Rel(orchestrator, tsDb, "Запись агрегатов/ряды", "SQL")
Rel(orchestrator, cache, "Кэш/сессии/троттлинг", "Redis")

' Интеграции
Rel(orchestrator, notif, "Оповещения", "HTTPS/WebPush")
Rel(orchestrator, erp, "Интеграции", "REST/ETL")
Rel(analyst, bi, "Витрины/отчёты", "BI")
Rel(bi, object, "Читает артефакты", "S3/Pre-signed")
Rel(dir, bi, "Дашборды KPI", "BI")

' Управление моделями/конфигами
Rel(reg, infer, "Выкат моделей и политики", "HTTPS")
Rel(configSvc, orchestrator, "Пороговые значения/ROI/фичи", "REST")
Rel(edgeFallback, op, "Локальные оповещения при офлайне", "Звук/свет/SMS локального провайдера")

@enduml
