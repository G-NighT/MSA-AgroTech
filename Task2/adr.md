# Название задачи

MVP «Платформа мониторинга скота» — ADR на уровне C2 (контейнеры) для двух архитектурных подходов  
A) **Edge-first** — инференс на фермах (основное решение)  
B) **Cloud-first** — центральный инференс, «тонкий» edge (альтернативное решение)

# Автор:

Минлигареев Максим Александрович

# Дата:

02.11.2025

---

## Проблема

Нужно выбрать архитектурный подход для MVP, обеспечив: реакцию на инциденты ≤ 5 сек, работу при нестабильной связи на фермах, масштабируемость по числу камер/датчиков и ясную декомпозицию на микросервисы. Требуется зафиксировать **ограниченные контексты**, интеграции, компромиссы и риски **двух вариантов** на уровне C2.

---

## Контекст

Исходные решения оформлены в `C2-main.puml` (Edge-first) и `C2-alt.puml` (Cloud-first). В обоих вариантах присутствуют: **API Gateway, IAM/SSO, Core (Платформа мониторинга), Media Service + S3, Config/Feature Service, Model Registry & Policy, операционная БД (PostgreSQL), хранилище телеметрии (Timescale/ClickHouse)**.  
Отличается расположение инференса и южная интеграция устройств:

- **Edge-first**: инференс и первичная обработка на фермах (Агент + Model Runner, локальный MQTT); центр — шина событий (Kafka), Core и интеграции.
- **Cloud-first**: видео с ферм поступает в Stream Gateway → центральный Realtime Inference (GPU) → Event Bus; датчики/актуаторы общаются с IoT Core (MQTT) центра.

---

## Ограниченные контексты (Bounded Contexts)

| Контекст                   | Ответственность                                    | Контейнеры в Edge-first                                     | Контейнеры в Cloud-first                       |
| -------------------------- | -------------------------------------------------- | ----------------------------------------------------------- | ---------------------------------------------- |
| **Edge Processing**        | Захват/обработка видео на ферме, офлайн-буфер      | Агент фермы; Model Runner; MQTT-брокер (локальный); Edge DB | Агент (тонкий); Fallback-эвристики; Edge DB    |
| **Inference**              | Выполнение моделей, выдача результатов             | Model Runner (на edge)                                      | Stream Gateway; Realtime Inference (GPU)       |
| **Monitoring & Incidents** | Корреляция, кейс-логика, статусы, SLA, эскалации   | Core: Платформа мониторинга                                 | Core: Платформа мониторинга                    |
| **Device Management**      | Команды/саги к устройствам                         | Device Control (через локальный MQTT)                       | Адаптер команд в Core → IoT Core (MQTT)        |
| **Telemetry**              | Сбор/агрегация рядов и метрик                      | Telemetry (через Kafka)                                     | Telemetry Writer (через IoT Core/Event Bus)    |
| **Media**                  | Хранение клипов/кадров, выдача pre-signed URL      | S3, Media Service                                           | S3, Media Service                              |
| **Configuration**          | Пороги, ROI, фичфлаги, таргетинг по фермам/камерам | Config/Feature Service                                      | Config/Feature Service                         |
| **Model Lifecycle**        | Версии/политики/выкаты моделей                     | Model Registry & Policy → OTA на edge                       | Model Registry & Policy → выкаты в GPU-кластер |
| **Access**                 | Аутентификация/авторизация, роли                   | IAM/SSO, API Gateway                                        | IAM/SSO, API Gateway                           |
| **Data Stores**            | Инциденты/справочники, временные ряды              | PostgreSQL; Timescale/ClickHouse                            | PostgreSQL; Timescale/ClickHouse               |

---

## Детали решений и интеграции

### A) Edge-first (основное)

- **Видео:** Камеры → Агент → локальный инференс (Model Runner).
- **События/телеметрия:** Агент публикует в **Kafka**; Core и сервисы потребляют/порождают события.
- **Устройства:** команды из Core → **локальный MQTT** на ферме (через Device Control).
- **Медиа:** Агент по событию отправляет клипы/кадры в **S3**; UI получает **pre-signed** ссылки через Media Service.
- **Модели:** Registry & Policy делает **OTA** на фермы (таргетинг по локациям, канареечные выкаты).

### B) Cloud-first (альтернативное)

- **Видео:** Агент (тонкий) → **Stream Gateway** → **Realtime Inference (GPU)**; результаты публикуются в **Event Bus**.
- **Датчики/актуаторы:** напрямую в **IoT Core (MQTT)** центра; Core посылает команды туда же.
- **Медиа/данные/доступ:** так же, как в Edge-first; модели выкатываются в **GPU-кластер**.

---

## Компромиссы

| Тема                           | Edge-first                                                       | Cloud-first                                              |
| ------------------------------ | ---------------------------------------------------------------- | -------------------------------------------------------- |
| **Задержка реакции**           | Минимальная и стабильная (мс), не зависит от uplink              | Зависит от канала до центра; выше вариативность          |
| **Офлайн-работа**              | Полноценная (инциденты, локальные действия), синхронизация позже | Ограничена; компенсируем простыми локальными эвристиками |
| **Сложность на фермах**        | «Толстый» edge, управление версиями плагинов                     | Упрощённый edge (без GPU), централизованный контроль     |
| **MLOps**                      | Распределённые выкаты (OTA), сложнее мониторить                  | Единый MLOps в центре (проще эксплуатация моделей)       |
| **Сеть/стоимость трафика**     | Меньше видеотрафика (летят события и клипы по триггерам)         | Значимый видеотрафик в центр                             |
| **Масштабируемость аналитики** | Масштабировать потребителей Kafka/хранилища                      | Масштабировать GPU-пул и Event Bus; зависимость от сети  |

---

## Риски и меры

### Общие для обоих

- **Ложные срабатывания/качество моделей** → пороги/ROI через Config, A/B и shadow-режимы, обратная связь оператора.
- **Стоимость хранения медиа** → политики TTL/жизненного цикла, хранить только «событийные» клипы, агрегировать телеметрию.
- **Наблюдаемость и устойчивость** → сквозной `correlationId`, идемпотентность (outbox), метрики/логи/трейсы, DLQ/репроцессинг.

### Специфично для Edge-first

- Управление парком edge-узлов и версиями плагинов → Registry & Policy, OTA, мониторинг состояния агентов.

### Специфично для Cloud-first

- Нестабильный uplink и задержки видео → оптимизация кодеков/битрейтов, ближние зоны размещения, fallback-правила и локальные уведомления на фермах.

---

## Решение (выбор на уровне C2)

Оба подхода жизнеспособны. Для пилота и запуска в условиях нестабильной связи и требования «реакция ≤ 5 сек» **рекомендуем Edge-first** как целевое. **Cloud-first** фиксируем как стратегическую альтернативу при приоритете централизованного MLOps и ограничениях по edge-железу.

---

## Ссылки на артефакты

- `C2-main.puml` — Edge-first (инференс на фермах).
- `C2-alt.puml` — Cloud-first (центральный инференс).
