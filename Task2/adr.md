# Название задачи:

MVP «Платформа мониторинга скота»: контейнерный уровень (два варианта: Kafka+MQTT и RabbitMQ+MQTT), Edge-инференс

# Автор:

Минлигареев Максим Александрович

# Дата:

29.10.2025

---

## Ограниченные контексты (Bounded Contexts)

| Контекст                   | Границы/ответственность                                                  | Основные контейнеры                                                             |
| -------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------------- |
| **Edge Processing**        | Видеоаналитика, локальные действия, офлайн-буфер, публикация событий     | Агент фермы; Model Runner (plugins); MQTT-брокер (локальный); Локальная БД Edge |
| **Monitoring & Incidents** | Обработка событий, кейс-логика, оповещения, интеграции                   | Core: Платформа мониторинга                                                     |
| **API & Access**           | Единая точка входа, маршрутизация, realtime-канал; аутентификация и роли | API Gateway; IAM/SSO                                                            |
| **Device Management**      | Команды на устройства, оркестрация/саги, обратная телеметрия             | Device Control Service                                                          |
| **Telemetry**              | Агрегация/экспорт базовых и кастомных метрик                             | Telemetry Service                                                               |
| **Media**                  | Хранение клипов/кадров, выдача pre-signed URL                            | Объектное хранилище (S3); Media Service                                         |
| **Configuration**          | Пороги моделей, ROI, фичфлаги/таргетинг по фермам                        | Config/Feature Service                                                          |
| **Model Lifecycle**        | Реестр моделей, подпись, политики выката, OTA-доставка                   | Model Registry & Policy                                                         |

---

## Диаграммы

- `C2-main.puml` — **Kafka + MQTT**, инференс на Edge.
- `C2-alt.puml` — **RabbitMQ + MQTT**, инференс на Edge.

---

## Решение и интеграции

### Общее (для обоих вариантов)

- **Ферма / Edge**:  
  IP-камеры → Агент фермы (Live-видео RTSP/WebRTC). Агент вызывает **Model Runner (plugins)** через gRPC/Unix-socket, формирует события и клипы; шлёт команды в **MQTT-брокер (локальный)**; буферизует данные в **Локальной БД Edge**; по событию грузит медиа в **Объектное хранилище (S3)** (pre-signed).
- **Центральная платформа**:  
  **API Gateway** ↔ **IAM/SSO** (OIDC/OAuth2). UI-запросы идут в **Core: Платформа мониторинга** (REST/gRPC, WebSocket/SSE).  
  **Media Service** генерирует pre-signed ссылки к S3.  
  **Device Control Service** публикует команды и обрабатывает ответы.  
  **Telemetry Service** собирает/экспортирует метрики.  
  **Config/Feature Service** рассылает пороги/ROI на фермы.  
  **Model Registry & Policy** выполняет OTA-доставку моделей/конфигов на Агент фермы.

### Вариант 1: Kafka + MQTT

- Шина: **Kafka (шина событий)** — топики `incident.*`, `telemetry.*`, `commands.*`.
- Интеграции: Агент фермы → Kafka (TLS); Core/сервисы читают/пишут события (consumer/producer).
- Данные: **Операционная БД (PostgreSQL)** для Core, **Хранилище телеметрии (Timescale/ClickHouse)** для рядов.

### Вариант 2: RabbitMQ + MQTT

- Шина: **RabbitMQ** (AMQP) — очереди/топики для событий, телеметрии, команд.
- Интеграции: Агент фермы публикует в AMQP; Core/сервисы подписываются/посылают команды.
- Данные: те же БД и S3; протокол шины — AMQP.

---

## Обоснование выбора технологий

- **MQTT** на «юге»: поддерживается большинством устройств, лёгкий протокол, QoS, годится для нестабильного Wi-Fi.
- **Kafka (осн.)**: реплей/ретеншн, горизонтальное масштабирование потребителей, подготовка к росту телеметрии и стрим-обработке; соответствует требованию ≤5 c до оповещения (низкая латентность при правильной конфигурации).
- **RabbitMQ (альт.)**: проще эксплуатация и быстрый пилот, привычные RPC/очереди; подходит при умеренных объёмах.
- **S3** + **Media Service**: дешёвое масштабируемое хранение медиа; отдача напрямую по pre-signed URL, без проксирования через API.
- **Edge-инференс**: выполняем требования по приватности и миллисекундной реакции; сеть нестабильна — решение не зависит от облака.

---

## Компромиссы

- **Edge-only** даёт мс-латентность и офлайн, но требует «толстый» edge и управление версиями плагинов (решается через Model Registry & Policy).
- **Kafka** сложнее операционно (кластеры/ZK/KRaft, мониторинг), но лучше масштабируется и даёт реплей.
- **RabbitMQ** проще, но ограничивает ретеншн/реплей, сложнее масштабировать потребителей под рост телеметрии.
- Pre-signed URL упрощает раздачу медиа, но требует строгого TTL и политики доступа.

---

## Риски и меры

| Риск                                    | Мера                                                                                           |
| --------------------------------------- | ---------------------------------------------------------------------------------------------- |
| Нестабильная связь на фермах            | Локальная БД Edge, ретраи, идемпотентность по `correlationId`, оповещение локальному персоналу |
| Ложные срабатывания моделей (ночь/тени) | Пороги/ROI в **Config/Feature Service**, калибровка, A/B и shadow-запуски                      |
| Дрифт качества/версионирование моделей  | **Model Registry & Policy**: подпись артефактов, канареечный выкат, быстрый откат              |
| Стоимость хранения медиа                | TTL/лайф-циклы, прежние кадры в «холод», хранить только клипы по событиям                      |
| Безопасность доступа                    | OIDC/OAuth2 + RBAC (IAM/SSO), TLS везде, presigned-policy, минимально необходимые права к S3   |
| SLA 99,95%                              | HA-кластеры шины, дублирование критичных сервисов, health-checks, автоперезапуск, алерты       |

---

## Итог решения

- Архитектурный стиль — событийная платформа «центральный сервер — агенты».
- Два рабочих варианта C2: Kafka+MQTT (основной) и RabbitMQ+MQTT (альтернативный).
- Инференс строго на Edge; центр — координация, хранение, оповещения и интеграции.
- Диаграммы `C2-main.puml` и `C2-alt.puml` приложены.
