# Название задачи:

MVP «Платформа мониторинга скота»: Критерии выбора решения (Kafka+MQTT vs RabbitMQ+MQTT)

# Автор:

Минлигареев Максим Александрович

# Дата:

30.10.2025

---

## Контекст

Есть два финальных варианта шины событий центральной платформы (инференс остаётся на Edge):

- **Вариант A (основной):** Kafka + MQTT.
- **Вариант B (альтернативный):** RabbitMQ + MQTT.

Необходимо сравнить решения по согласованным критериям и дать рекомендацию.

---

## Критерии оценки и веса

Вес — относительная значимость в контексте MVP и масштабирования.

|   № | Критерий                                  | Что измеряем                                           |  Вес |
| --: | ----------------------------------------- | ------------------------------------------------------ | ---: |
|   1 | Производительность/латентность оповещения | P95 от события до алерта (≤ 5c)                        | 0.15 |
|   2 | Масштабирование потребителей/телеметрии   | Линейное масштабирование подписчиков, реплей           | 0.15 |
|   3 | Надёжность/устойчивость                   | Репликация, ретеншн, восстановление, гарантия доставки | 0.12 |
|   4 | Наблюдаемость и отладка                   | Трассировка, метрики, DLQ/реплей, инструменты          | 0.10 |
|   5 | Простота эксплуатации                     | Разворачивание/апгрейды, штатная команда эксплуатации  | 0.12 |
|   6 | Гибкость интеграций                       | Паттерны pub/sub, streams, CDC, outbox, совместимость  | 0.10 |
|   7 | Стоимость владения (TCO)                  | Лицензии/облако/поезд, Ops time                        | 0.10 |
|   8 | Риски и вендор-агностичность              | Возможность миграции/замены                            | 0.08 |
|   9 | Соответствие будущему росту               | Потоковая аналитика/проекции, multi-tenant             | 0.08 |

Баллы: 1 — плохо, 3 — приемлемо, 5 — отлично.

---

## Оценка вариантов (баллы \* вес)

| Критерий                          |      Kafka + MQTT |   RabbitMQ + MQTT |
| --------------------------------- | ----------------: | ----------------: |
| 1. Производительность/латентность | 5×0.15 = **0.75** | 4×0.15 = **0.60** |
| 2. Масштабирование/реплей         | 5×0.15 = **0.75** | 3×0.15 = **0.45** |
| 3. Надёжность/ретеншн             | 5×0.12 = **0.60** | 4×0.12 = **0.48** |
| 4. Наблюдаемость/отладка          | 4×0.10 = **0.40** | 4×0.10 = **0.40** |
| 5. Эксплуатация                   | 3×0.12 = **0.36** | 5×0.12 = **0.60** |
| 6. Гибкость интеграций            | 5×0.10 = **0.50** | 4×0.10 = **0.40** |
| 7. Стоимость владения             | 3×0.10 = **0.30** | 4×0.10 = **0.40** |
| 8. Риски/вендор-агностичность     | 4×0.08 = **0.32** | 4×0.08 = **0.32** |
| 9. Рост/стрим-аналитика           | 5×0.08 = **0.40** | 3×0.08 = **0.24** |
| **Итог**                          |          **4.38** |          **3.89** |

---

## Разбор по критериям

### Вариант A — Kafka + MQTT

**Плюсы**

- Нативный **реплей/ретеншн** потоков, партиционирование, consumer groups — удобно масштабировать обработчики телеметрии и инцидентов.
- Хорошая база для **онлайн-агрегаций/проекций** (Kafka Streams/Flink), что важно для дашбордов и быстрых чтений в будущем.
- Большая экосистема коннекторов (CDC, DLQ через отдельные топики), outbox-паттерн естественно ложится на доменные события.
- Легко выдержать SLA **≤ 5c** при корректной конфигурации партиций/acks.

**Минусы/риски**

- Опасность **операционной сложности** (кластер, KRaft, ретеншн, мониторинг).
- Более высокая **стоимость владения** при малом масштабе.

**Когда уместно:** с пилота на 10–20 ферм уже виден выигрыш, а при росте телеметрии/камер — практически безальтернативно.

---

### Вариант B — RabbitMQ + MQTT

**Плюсы**

- **Простая эксплуатация**, быстрый старт команды Ops, знакомые шаблоны RPC/очередей.
- Низкий TCO для небольшого объёма событий.

**Минусы/риски**

- **Нет нативного реплея**; ретеншн ограничен — сложнее отлаживать/догонять отставшие сервисы.
- Горизонтальное масштабирование потребителей телеметрии хуже, чем у Kafka.
- При росте числа ферм/камер возникнет потребность миграции на Kafka или усложнение с DLX/TTL-цепочками.

**Когда уместно:** очень небольшой пилот с ограниченной телеметрией и минимальной DevOps-нагрузкой.

---

## Рекомендация

**Рекомендуем Вариант A: Kafka + MQTT** как целевое решение платформы.  
Причины: соответствие NFR (латентность ≤ 5c, доступность 99,95%), лучшая масштабируемость и наблюдаемость при росте количества ферм/камер, готовность к онлайн-агрегациям и материализованным проекциям.

**Допустимое исключение:** если пилот ограничен 1–3 фермами и нет выделенной эксплуатации — можно стартовать с RabbitMQ, но зафиксировать **план миграции** на Kafka.

---

## План внедрения и снятие рисков

1. **Пилот (≤3 ферм):**

   - Kafka с минимальным HA (3 брокера, KRaft), ретеншн 7–14 дней, DLQ-топики.
   - Схемы событий: JSON → далее Avro/Protobuf + Registry.
   - Сквозные `correlationId`, outbox в Core.

2. **Миграция с RabbitMQ (если использовался):**

   - Запуск **шлюза-бриджа** (RMQ→Kafka) для «двойной записи»; постепенная перенастройка потребителей.
   - Проверка идемпотентности ключами (`eventId`) и семантики «по крайней мере одна доставка».

3. **Наблюдаемость:**

   - Метрики шины/потребителей (lag, throughput), трассировка; алерты по SLA.

4. **Стоимость:**
   - Политики ретеншна; переразбиение партиций по мере роста; архивация холодных данных.

---

## Решение

Выбрать **Kafka + MQTT** как основную шину событий для MVP и дальнейшего масштабирования.  
RabbitMQ оставить как **резервный упрощённый вариант** только для ограниченных пилотов; предусмотреть мост для миграции.
