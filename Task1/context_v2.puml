@startuml C1-alt
' C4-PlantUML (Context)
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
LAYOUT_TOP_DOWN()

title C1 — Платформа мониторинга скота (RabbitMQ + MQTT, Edge-инференс)

' === Акторы ===
Person(op, "Оператор фермы", "Реагирует на события")
Person(vet, "Ветврач", "Анализ состояния")
Person(dir, "Директор хозяйства", "Сводная аналитика и KPI")
Person(analyst, "Аналитик", "BI/отчётность")
Person(mobile, "Мобильное приложение", "Уведомления/действия")

' === Ферма / Edge ===
System_Boundary(edge, "Ферма / Edge") {
  System_Ext(cam, "IP-камеры", "RTSP")
  System_Ext(sensors, "Датчики/актуаторы", "MQTT")
  System(edgeAgent, "Агент фермы", "Видеоаналитика, управление, буфер офлайн")
  System(edgeRunner, "Model Runner (plugins)", "Запуск партнёрских моделей локально")
  System(mqttLocal, "MQTT-брокер (локальный)", "Телеметрия/команды")

  Rel(cam, edgeAgent, "Live видео", "RTSP/WebRTC")
  Rel(sensors, mqttLocal, "Телеметрия", "MQTT")
  Rel(edgeAgent, mqttLocal, "Команды", "MQTT")
  Rel(edgeAgent, edgeRunner, "Инференс по кадру/клипу", "gRPC / shared fs")
}

' === Центр ===
System_Boundary(central, "Центральная платформа") {
  System(core, "Core: Платформа мониторинга", "Приём событий, кейс-логика, оповещения")
  System(rmq, "RabbitMQ", "Очереди/топики: события, команды, алерты")
  System(object, "Объектное хранилище (S3)", "Клипы/кадры")
  System(auth, "IAM/SSO", "OIDC/SAML; RBAC")
  System(api, "API Gateway", "REST/gRPC")
  System(reg, "Model Registry & Policy", "Реестр моделей/политики выката")
  System_Ext(erp, "ERP", "REST/ETL")
  System_Ext(bi, "BI/ВИ-система", "Отчёты")
  System_Ext(notif, "Сервис уведомлений", "SMS/Email/WebPush")
}

' === Связи edge ↔ центр ===
Rel(edgeAgent, rmq, "Публикует события/телеметрию", "AMQP over TLS")
Rel(core, rmq, "Команды/подписка", "AMQP")
Rel(edgeAgent, object, "Клипы/кадры по событию", "S3 API")
Rel(core, notif, "Оповещения", "HTTPS/WebPush")
Rel(op, api, "Веб-портал", "HTTPS")
Rel(mobile, api, "Мобильное приложение", "HTTPS")
Rel(api, auth, "Авторизация", "OIDC/OAuth2")
Rel(core, erp, "Интеграции", "REST/ETL")
Rel(bi, object, "Доступ к данным", "S3/Pre-signed")
Rel(analyst, bi, "BI-отчёты", "BI")
Rel(dir, bi, "Дашборды KPI", "BI")
Rel(reg, edgeAgent, "OTA-доставка артефактов моделей,\nполитики выката (canary/по локациям)", "HTTPS/S3")

@enduml
