# Название задачи:

MVP «Платформа мониторинга скота»: контекст и ключевые решения (Kafka+MQTT, Edge-инференс)

# Автор:

Минлигареев Максим Александрович

# Дата:

28.10.2025

---

## Функциональные требования

|   № | Действующие лица или системы | Use Case                       | Описание                                                                                                                         |
| --: | ---------------------------- | ------------------------------ | -------------------------------------------------------------------------------------------------------------------------------- |
|   1 | Камеры, Агент фермы          | Детекция драк/беспокойства     | Агент получает RTSP-видео, локальная модель выявляет «fight/overcrowding», формирует событие и клип. Оповещение оператору ≤ 5 с. |
|   2 | Камеры, Агент фермы          | Детекция задавливания поросят  | Edge-модель распознаёт риск задавливания, возвращает координаты/кадры; создаётся инцидент и эскалация.                           |
|   3 | Датчики/актуаторы, Агент     | Управление кормушками/поилками | Команды через MQTT, обратная телеметрия, идемпотентность и защита от «залипания».                                                |
|   4 | Датчики воды                 | Контроль фильтрации воды       | Пороговые/прогнозные алерты по давлению/мутности; связь с инцидентами.                                                           |
|   5 | Камеры                       | Пересчёт поголовья             | Периодические задания на edge, ручная верификация в UI, хранение результатов.                                                    |
|   6 | ERP                          | Учёт запасов корма             | Импорт/экспорт номенклатур и остатков, прогноз потребления.                                                                      |
|   7 | Сервис уведомлений           | Оповещения                     | Push/SMS/Email; каналы и эскалации по ролям.                                                                                     |
|   8 | Оператор (веб/мобайл)        | Просмотр live и клипов         | Live по WebRTC/RTSP на edge; клипы/кадры из S3 по защищённым ссылкам.                                                            |
|   9 | Система                      | Офлайн и синхронизация         | Буфер на edge (события/медиа), надёжная доотправка при восстановлении связи.                                                     |
|  10 | Аналитик/BI                  | Отчёты и витрины               | Загрузка артефактов/метаданных в витрины, построение KPI/дашбордов.                                                              |
|  11 | IAM/SSO                      | Роли и доступ                  | OIDC/OAuth2/SAML, RBAC: оператор, ветврач, аналитик, директор.                                                                   |
|  12 | Model Registry               | Управление моделями            | Версионирование, подпись и OTA-доставка пакетов моделей на фермы по политикам выката.                                            |

---

## Нефункциональные требования

|   № | Требование                                                                               |
| --: | ---------------------------------------------------------------------------------------- |
|  N1 | Доступность центральной платформы 99,95%.                                                |
|  N2 | Событие → уведомление ≤ 5 секунд (P95).                                                  |
|  N3 | Edge-инференс — миллисекунды на кадр.                                                    |
|  N4 | Масштабируемость по числу ферм/камер; горизонтальное масштабирование потребителей шины.  |
|  N5 | Офлайн-работа на ферме: буферизация событий и медиа, идемпотентная синхронизация.        |
|  N6 | Безопасность: TLS, RBAC, секреты в Vault, подпись артефактов моделей, изоляция плагинов. |
|  N7 | Наблюдаемость: метрики/логи/трейсинг; корреляция по `correlationId`.                     |
|  N8 | Совместимость: RTSP/ONVIF/MQTT; версионирование контрактов.                              |
|  N9 | Стоимость: политики TTL/лайф-циклов для S3; горячее/холодное хранение.                   |
| N10 | Приватность/регуляторика: локальная обработка видео, без передачи кадров в облако.       |

---

## Решение

- Событийная архитектура: **Kafka** — шина доменных событий/телеметрии/интеграций; **MQTT** — «юг» для датчиков и актуаторов.
- Видео вне шины: **live — RTSP/WebRTC** через edge-прокси; по событию — клипы/кадры в **S3**, ссылки и метаданные в событиях.
- **Edge-инференс только на фермах**: **Model Runner (plugins)** исполняет пакеты партнёрских моделей (ONNX/TensorRT/PyTorch) через gRPC.
- **Model Registry & Policy** (центр): версии, подпись, совместимость CPU/GPU, **OTA-доставка** артефактов и политики выката (canary/по локациям).
- Идемпотентная синхронизация: буфер на edge, ретраи, дедупликация по `correlationId`.
- Безопасность и доступ: OIDC/OAuth2/SAML, TLS end-to-end, секреты в Vault, изоляция плагинов (seccomp/AppArmor/контейнеры).
- Наблюдаемость: метрики (`latency_ms`, `success_ratio`, `edge_gpu_util`, `queue_depth`), трейсинг сквозь Агент → Kafka → Core.

---

## Альтернативы

- Облачный инференс через Inference Gateway: гибкость и единые SLA, но передача видео/кадров вовне и дополнительная задержка; **отклонено**.
- RabbitMQ вместо Kafka (с MQTT на «юге»): проще для пилота, но слабее реплей/стрим-аналитика и масштабирование потребителей.
- Стримить live-видео через шину: не укладывается в низкую задержку; оставляем только метаданные и артефакты.

---

## Недостатки, ограничения, риски

- «Толстый» edge (требования к железу, управление версиями плагинов); операционная сложность Kafka и реестра моделей.
- Сложные условия съёмки (ночь/пыль/скопления) → калибровка и маски зон.
- Затраты на хранение медиа → политики TTL/лайф-циклов S3.

**Риски и меры:** нестабильная связь (буфер, ретраи, идемпотентность); деградация качества моделей (shadow/A-B, обратная связь в UI); безопасность (подпись артефактов, изоляция плагинов, минимум привилегий); несовместимость железа (матрица совместимости в реестре, поэтапный выкат).
