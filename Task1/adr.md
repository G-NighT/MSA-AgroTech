# Название задачи:

MVP «Платформа мониторинга скота»: контекст и ключевые решения (Kafka+MQTT, Edge-инференс)

# Автор:

Минлигареев Максим Александрович

# Дата:

28.10.2025

---

## Функциональные требования

|   № | Действующие лица или системы | Use Case                       | Описание                                                                                                                         |
| --: | ---------------------------- | ------------------------------ | -------------------------------------------------------------------------------------------------------------------------------- |
|   1 | Камеры, Агент фермы          | Детекция драк/агрессии         | Агент получает RTSP-видео, локальная модель выявляет «fight/overcrowding», формирует событие и клип. Оповещение оператору ≤ 5 с. |
|   2 | Камеры, Агент фермы          | Риск задавливания              | Edge-модель фиксирует риск задавливания поросят, возвращает координаты/кадры; создаётся инцидент и эскалация.                    |
|   3 | Датчики/актуаторы, Агент     | Управление кормушками/поилками | Команды через MQTT, обратная телеметрия, идемпотентность и защита от «залипания».                                                |
|   4 | Датчики воды                 | Контроль фильтрации воды       | Пороговые/прогнозные алерты по давлению/мутности; привязка к инцидентам.                                                         |
|   5 | Камеры                       | Пересчёт поголовья             | Периодические задания на edge, ручная верификация в UI, хранение результатов.                                                    |
|   6 | ERP                          | Учёт запасов корма             | Импорт/экспорт номенклатур и остатков, прогноз потребления.                                                                      |
|   7 | Сервис уведомлений           | Оповещения                     | Push/SMS/Email; каналы и эскалации по ролям.                                                                                     |
|   8 | Оператор (веб/мобайл)        | Просмотр live и клипов         | Live по WebRTC/RTSP (через edge-прокси); клипы/кадры из S3 по защищённым ссылкам.                                                |
|   9 | Система                      | Офлайн и синхронизация         | Буфер на edge (события/медиа), надёжная доотправка при восстановлении связи.                                                     |
|  10 | Аналитик/BI                  | Отчёты и витрины               | Формирование витрин/дашбордов, доступ к артефактам.                                                                              |
|  11 | IAM/SSO                      | Роли и доступ                  | OIDC/OAuth2/SAML, RBAC: оператор, ветврач, аналитик, директор.                                                                   |
|  12 | Model Registry               | Управление моделями            | Версионирование, подпись, совместимость, OTA-доставка пакетов моделей на фермы по политикам выката.                              |

---

## Нефункциональные требования

|   № | Требование                                                                               |
| --: | ---------------------------------------------------------------------------------------- |
|  N1 | Доступность центральной платформы 99,95%.                                                |
|  N2 | Событие → уведомление ≤ 5 секунд (P95).                                                  |
|  N3 | Edge-инференс — миллисекунды на кадр.                                                    |
|  N4 | Масштабируемость по числу ферм/камер; горизонтальное масштабирование потребителей шины.  |
|  N5 | Офлайн-работа на ферме: буферизация событий и медиа, идемпотентная синхронизация.        |
|  N6 | Безопасность: TLS, RBAC, секреты в Vault, подпись артефактов моделей, изоляция плагинов. |
|  N7 | Наблюдаемость: метрики/логи/трейсинг; корреляция по `correlationId`.                     |
|  N8 | Совместимость: RTSP/ONVIF/MQTT; версионирование контрактов.                              |
|  N9 | Стоимость: политики TTL/жизненные циклы для S3; горячее/холодное хранение.               |
| N10 | Приватность: локальная обработка видео; кадры не покидают ферму.                         |

---

## Решение

- **Архитектурный стиль:** событийная платформа.
- **Транспорты:** Kafka (основное решение) как шина доменных событий/телеметрии; MQTT — «юг» (датчики/актуаторы).
- **Видео:** live вне шины (RTSP/WebRTC на edge); по событию — клипы/кадры в S3; в событиях — ссылки и метаданные.
- **Инференс:** только на фермах — `Model Runner (plugins)` исполняет пакеты партнёрских моделей (ONNX/TensorRT/OpenVINO) через gRPC.
- **Model Registry & Policy:** версии/подпись/совместимость CPU/GPU, политики выката (canary/по локациям), OTA-доставка на фермы.
- **API и доступ:** Web/Mobile → API Gateway → Core (REST/gRPC + WS/SSE); авторизация через IAM/SSO (OIDC/OAuth2).
- **Медиа-доступ:** Core генерирует pre-signed URL к S3; клиенты забирают медиа напрямую.

**Диаграммы:** `C1-main.puml` и `C1-alt.puml`.

---

## Альтернативы

1. **RabbitMQ вместо Kafka (сохранён MQTT на «юге»).**  
   Плюсы: Проще эксплуатация для пилота; привычные паттерны RPC/очередей.  
   Минусы: Нет «реплея»/ретеншна потока, слабее стрим-аналитика, сложнее масштабировать потребителей при росте телеметрии.

2. **Облачный инференс (Inference Gateway).**  
   Плюсы: Единые SLA с провайдерами.  
   Минусы: Передача кадров вовне и дополнительная задержка; противоречит edge-требованию.  
   **Отклонено.**

3. **Стриминг live-видео через шину сообщений.**  
   Минусы: Не укладывается в низкую задержку и стоимость; оставляем только метаданные/артефакты.  
   **Отклонено.**

---

## Недостатки, ограничения, риски

- «Толстый» edge: требования к железу, управление версиями плагинов.
- Операционная сложность Kafka и реестра моделей; в альтернативе — ограничения RabbitMQ для потоков.
- Условия съёмки (ночь/пыль/скученность) — нужна калибровка/маски.
- Стоимость хранения медиа — политики TTL/лайф-циклы S3.

**Риски и меры:** нестабильная связь (дисковый буфер на edge, ретраи, идемпотентность по `correlationId`); деградация качества моделей (shadow/A-B, обратная связь из UI); безопасность (подпись артефактов, изоляция плагинов, минимум привилегий); несовместимость железа (матрица совместимости в реестре, поэтапные выкаты).
