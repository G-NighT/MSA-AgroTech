@startuml C3-core-alt

!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

top to bottom direction

title C3 — Core: Платформа мониторинга (RabbitMQ + MQTT)

Container_Boundary(core, "Core: Платформа мониторинга") {
  Component(RestApi, "REST/gRPC API", "Controller", "Эндпоинты: инциденты, управление, отчёты")
  Component(Realtime, "Realtime Gateway", "WS/SSE", "Онлайновые обновления")
  Component(EventConsumer, "Event Consumer", "AMQP consumer", "Очереди/топики: events, telemetry")
  Component(EventProducer, "Event Producer", "AMQP producer", "Команды/доменные события")
  Component(IncidentSvc, "Incident Service", "Domain service", "Правила/эскалации/SLA")
  Component(DeviceOrch, "Device Orchestrator", "Saga", "Команды к устройствам, компенсации")
  Component(ConfigClient, "Config Client", "Client", "Пороговые/ROI")
  Component(MediaClient, "Media Client", "Client", "Pre-signed URL")
  Component(NotifClient, "Notification Client", "Client", "SMS/Email/WebPush")
  Component(ErpClient, "ERP Client", "Client", "REST/ETL")
  Component(Repo, "Repositories", "DAL", "Incidents/Devices/Settings + Outbox")
  Component(Metrics, "Observability", "Tracing/Metrics", "Метрики/логи/трейсинг")
}

System_Ext(rmq, "RabbitMQ", "AMQP: events, telemetry, commands")
SystemDb(opdb, "Операционная БД", "PostgreSQL", "Инциденты, справочники, команды, outbox, конфиги")
System_Ext(object, "Объектное хранилище (S3)", "Клипы/кадры/артефакты")
System_Ext(notif, "Сервис уведомлений", "HTTPS/WebPush")
System_Ext(erp, "ERP", "REST/ETL")
System_Ext(auth, "IAM/SSO", "OIDC/SAML; RBAC")

Rel(RestApi, auth, "Проверка токенов/JWK", "OIDC/OAuth2")
Rel(RestApi, IncidentSvc, "CRUD/команды")
Rel(Realtime, IncidentSvc, "события для онлайна")
Rel(EventConsumer, IncidentSvc, "events/telemetry")
Rel(IncidentSvc, EventProducer, "domain events/commands")
Rel(IncidentSvc, DeviceOrch, "оркестрация")
Rel(DeviceOrch, EventProducer, "commands")
Rel(IncidentSvc, ConfigClient, "пороги/ROI")
Rel(IncidentSvc, MediaClient, "ссылки на клипы/кадры")
Rel(MediaClient, object, "pre-signed, TTL", "S3 SDK")
Rel(IncidentSvc, NotifClient, "уведомления")
Rel(NotifClient, notif, "SMS/Email/WebPush")
Rel(IncidentSvc, ErpClient, "интеграции")
Rel(ErpClient, erp, "REST/ETL")
Rel(Repo, opdb, "SQL")
Rel(EventConsumer, rmq, "Consume", "AMQP")
Rel(EventProducer, rmq, "Publish", "AMQP")
Rel(IncidentSvc, Repo, "чтение/запись")
Rel(Metrics, IncidentSvc, "метрики/трейсинг")

@enduml
